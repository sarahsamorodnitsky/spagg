---
title: "Considering Multiple Radii in a spagg Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SPOT}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
use-biblatex: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(spagg)
library(SPOT)
library(dplyr)
library(magrittr)
library(spatstat)
library(ggplot2)
library(tidyr)
```

To apply spatial summary statistics, like Ripley's K, in analyses of multiplexed spatial proteomics imaging data, the user is required to select a radius in which to quantify the degree of clustering, repulsion, or lack thereof. The optimal radius, however, is typically unknown beforehand. To this end, it can be helpful to consider a range of candidate radii at which to calculate Ripley's K and test for an association at each radius, aggregating the resulting p-values. This is the idea behind the SPatial Omnibus Test (SPOT) @samorodnitsky2024spatial. In this vignette, we discuss integrating `spagg` with SPOT using the associated R package, `SPOT`. This will allow us to compute Ripley's K at several candidate radii, aggregate the resulting spatial summary statistics for a given radius within a sample across regions-of-interest (ROIs), test for an association between the aggregated spatial summary and an outcome, and combine the results across radii. 

To start, first ensure the `SPOT` `R` package is available on your computer. To download, follow the instructions given here:

```{r downloading SPOT, eval = FALSE}
library(devtools)
devtools::install_github("sarahsamorodnitsky/SPOT")
library(SPOT)
```

For this analysis, we will use the lung cancer dataset used in the `spagg` vignette. As described in that vignette, we will downloaded the data from http://juliawrobel.com/MI_tutorial/MI_Data.html but is also available from the `VectraPolarisData` R package. For the purposes of this illustration, we do some basic tidying of the data prior to analysis. The steps to this are similar to those given in the link given above. These steps are shown below. 

```{r data}
# Load in the data
load(url("http://juliawrobel.com/MI_tutorial/Data/lung.RDA"))

# Label the immune cell types
lung_df <- lung_df %>%
  mutate(type = case_when(
    phenotype_cd14 == "CD14+" ~ "CD14+ cell",
    phenotype_cd19 == "CD19+" ~ "CD19+ B cell",
    phenotype_cd4 == "CD4+" ~ "CD4+ T cell",
    phenotype_cd8 == "CD8+" ~ "CD8+ T cell",
    phenotype_other == "Other+" ~ "Other",
    phenotype_ck == "CK+" ~ "Tumor"
  ))

# Add a column indicating if a sample has >=5% MHCII+ tumor cells
lung_df <- lung_df %>%                       
  dplyr::group_by(patient_id) %>% 
  dplyr::mutate(mhcII_high = as.numeric(mhcII_status == "high"))

# Change colnames
colnames(lung_df)[colnames(lung_df) == "patient_id"] <- "PID"

# Add a PID column
colnames(lung_df)[colnames(lung_df) == "image_id"] <- "id"

# Filter to just cells detected within the tumor
lung_df_tumor <- lung_df %>% filter(tissue_category == "Tumor")

# Remove grouping
lung_df_tumor <- lung_df_tumor %>% dplyr::ungroup()

# Remove NA types
lung_df_tumor <- lung_df_tumor %>% filter(!is.na(type))

# Show the first few rows of the data
head(lung_df_tumor)
```

There are four immune cell types available in this dataset: CD14+ cell, CD4+ T cell, CD8+ T cell, and CD19+ B cell. We will examine the pairwise colocalization of each cell type and its association with a sample exhibiting an MHCII-high tumor microenvironment (TME). Here, we generate each pair of cell types:

```{r pairs of cells}
# Save the cell types
cell.types <- unique(lung_df_tumor$type)[3:6]

# Generate all pairs of cells
pairs <- t(combn(cell.types, 2))
```
As described in the introductory vignette, `spagg` contains six approaches for aggregating spatial summaries at a given radius. 

The first three approaches are weighted means of the summary statistics:

(1) 
\begin{equation*}
\bar K_i^{Diggle} = \frac{1}{\sum_{r=1}^{R_i} n_{ir}} \sum_{r=1}^{R_i} n_{ir} \hat K_{ir}
\end{equation*}

(2)
\begin{equation*}
  \bar K_i^{Baddeley} = \frac{1}{\sum_{r=1}^{R_i} n^2_{ir}} \sum_{r=1}^{R_i} n^2_{ir} \hat K_{ir} \end{equation*}

(3)
\begin{equation*}
  \bar K_i^{Landau} = \frac{\sum_{r=1}^{R_i} A_{ir}}{\sum_{r=1}^{R_i} n_{ir}} \sum_{r=1}^{R_i} \frac{n^2_{ir}}{A_{ir}} \hat K_{ir} 
\end{equation*}

The last three are ensemble approaches which involve generating random weights used to aggregate the spatial summaries:

(4) Ensemble testing: in this approach, `spagg` randomly generates weights from a standard normal distribution which are used to construct a weighted mean of the Ripley's K estimates obtained from each ROI. This process is repeated many times. For each random set of weights, the association between the weighted mean spatial summary and sample-level outcomes is tested. The resulting p-values are combined using the Cauchy combination test. This approach is contained in the `ensemble.avg` function. 

(5) Resampling: in this approach, `spagg` randomly samples one spatial summary statisti per sample and tests for an association with the sample-level outcome. This process is repeated many times and the resulting p-values are combined using the Cauchy combination test. This approach is contained in the `resampling.avg` function. 

(6) Combination testing: in this approach, `spagg` randomly generates weights from a standard normal distribution and uses these weights as well as the number of cells in each ROI to construct a weighted mean of Ripley's K estimates. This process is repeated many times and the resulting p-values are combined using the Cauchy combination test. This approach is contained in the `combo.weight.avg` function. 

We will illustrate applying each of these six methods, as well as a standard arithmetic mean, within the SPOT framework. The steps to our analysis are as follows:

1. We will determine a range of candidate radii in advance. For this analysis, we will use 10 radii between $0$ and $30$. 

2. We will compute Ripley's K for each radius $r = 0, 10, 20, 30$ and for each ROI. Within each sample, we will aggregate the spatial summaries across ROIs using an arithmetic mean, the Diggle mean, the Landau mean, and the Baddeley mean. We will then test for an association between the aggregated spatial summaries and MHCII-high status. At the end, we will aggregate the p-values using the Cauchy combination test (CCT) @liu2020cauchy. 

3. We will also use the ensemble approaches to aggregate the spatial summaries and test for an association with the outcome. This will involve two nested p-value combination steps: (1) at the ensemble testing level, we will aggregate the p-values using the CCT across ensemble replications; (2) at the SPOT level, we will aggregate the ensemble p-values across radii using the CCT again. 

4. At the end, we will assess which cell type pairs have significant associations with MHCII-high status. 

Note that this analysis differs from the analysis presented in the manuscript associated with this package. There, we considered a wider range of radii and more ensemble replications. For the purposes of illustration and simplicity, we reduce the number of radii and the number of ensemble replications. 
