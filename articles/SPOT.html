<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Considering Multiple Radii in a spagg Analysis • spagg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Considering Multiple Radii in a spagg Analysis">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spagg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/spagg.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/SPOT.html">Considering Multiple Radii in a spagg Analysis</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Considering Multiple Radii in a spagg Analysis</h1>
            
      

      <div class="d-none name"><code>SPOT.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sarahsamorodnitsky.github.io/spagg/">spagg</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SPOT</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://spatstat.org/" class="external-link">spatstat</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: spatstat.data</span></span>
<span><span class="co">#&gt; Loading required package: spatstat.univar</span></span>
<span><span class="co">#&gt; spatstat.univar 3.0-0</span></span>
<span><span class="co">#&gt; Loading required package: spatstat.geom</span></span>
<span><span class="co">#&gt; spatstat.geom 3.3-2</span></span>
<span><span class="co">#&gt; Loading required package: spatstat.random</span></span>
<span><span class="co">#&gt; spatstat.random 3.3-1</span></span>
<span><span class="co">#&gt; Loading required package: spatstat.explore</span></span>
<span><span class="co">#&gt; Loading required package: nlme</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'nlme'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     collapse</span></span>
<span><span class="co">#&gt; spatstat.explore 3.3-1</span></span>
<span><span class="co">#&gt; Loading required package: spatstat.model</span></span>
<span><span class="co">#&gt; Loading required package: rpart</span></span>
<span><span class="co">#&gt; spatstat.model 3.3-1</span></span>
<span><span class="co">#&gt; Loading required package: spatstat.linnet</span></span>
<span><span class="co">#&gt; spatstat.linnet 3.2-1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; spatstat 3.1-1 </span></span>
<span><span class="co">#&gt; For an introduction to spatstat, type 'beginner'</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'tidyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:magrittr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     extract</span></span></code></pre></div>
<p>To apply spatial summary statistics, like Ripley’s K, in analyses of
multiplexed spatial proteomics imaging data, the user is required to
select a radius in which to quantify the degree of clustering,
repulsion, or lack thereof. The optimal radius, however, is typically
unknown beforehand. To this end, it can be helpful to consider a range
of candidate radii at which to calculate Ripley’s K and test for an
association at each radius, aggregating the resulting p-values. This is
the idea behind the SPatial Omnibus Test (SPOT) <span class="citation">@samorodnitsky2024spatial</span>. In this vignette, we
discuss integrating <code>spagg</code> with SPOT using the associated R
package, <code>SPOT</code>. This will allow us to compute Ripley’s K at
several candidate radii, aggregate the resulting spatial summary
statistics for a given radius within a sample across regions-of-interest
(ROIs), test for an association between the aggregated spatial summary
and an outcome, and combine the results across radii.</p>
<p>To start, first ensure the <code>SPOT</code> <code>R</code> package
is available on your computer. To download, follow the instructions
given here:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"sarahsamorodnitsky/SPOT"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SPOT</span><span class="op">)</span></span></code></pre></div>
<p>For this analysis, we will use the lung cancer dataset used in the
<code>spagg</code> vignette. As described in that vignette, we will
downloaded the data from <a href="http://juliawrobel.com/MI_tutorial/MI_Data.html" class="external-link uri">http://juliawrobel.com/MI_tutorial/MI_Data.html</a> but is
also available from the <code>VectraPolarisData</code> R package. For
the purposes of this illustration, we do some basic tidying of the data
prior to analysis. The steps to this are similar to those given in the
link given above. These steps are shown below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load in the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"http://juliawrobel.com/MI_tutorial/Data/lung.RDA"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Label the immune cell types</span></span>
<span><span class="va">lung_df</span> <span class="op">&lt;-</span> <span class="va">lung_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">phenotype_cd14</span> <span class="op">==</span> <span class="st">"CD14+"</span> <span class="op">~</span> <span class="st">"CD14+ cell"</span>,</span>
<span>    <span class="va">phenotype_cd19</span> <span class="op">==</span> <span class="st">"CD19+"</span> <span class="op">~</span> <span class="st">"CD19+ B cell"</span>,</span>
<span>    <span class="va">phenotype_cd4</span> <span class="op">==</span> <span class="st">"CD4+"</span> <span class="op">~</span> <span class="st">"CD4+ T cell"</span>,</span>
<span>    <span class="va">phenotype_cd8</span> <span class="op">==</span> <span class="st">"CD8+"</span> <span class="op">~</span> <span class="st">"CD8+ T cell"</span>,</span>
<span>    <span class="va">phenotype_other</span> <span class="op">==</span> <span class="st">"Other+"</span> <span class="op">~</span> <span class="st">"Other"</span>,</span>
<span>    <span class="va">phenotype_ck</span> <span class="op">==</span> <span class="st">"CK+"</span> <span class="op">~</span> <span class="st">"Tumor"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a column indicating if a sample has &gt;=5% MHCII+ tumor cells</span></span>
<span><span class="va">lung_df</span> <span class="op">&lt;-</span> <span class="va">lung_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>                       </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">patient_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mhcII_high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mhcII_status</span> <span class="op">==</span> <span class="st">"high"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Change colnames</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span> <span class="op">==</span> <span class="st">"patient_id"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"PID"</span></span>
<span></span>
<span><span class="co"># Add a PID column</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span> <span class="op">==</span> <span class="st">"image_id"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"id"</span></span>
<span></span>
<span><span class="co"># Filter to just cells detected within the tumor</span></span>
<span><span class="va">lung_df_tumor</span> <span class="op">&lt;-</span> <span class="va">lung_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tissue_category</span> <span class="op">==</span> <span class="st">"Tumor"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove grouping</span></span>
<span><span class="va">lung_df_tumor</span> <span class="op">&lt;-</span> <span class="va">lung_df_tumor</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove NA types</span></span>
<span><span class="va">lung_df_tumor</span> <span class="op">&lt;-</span> <span class="va">lung_df_tumor</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the first few rows of the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lung_df_tumor</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 39</span></span></span>
<span><span class="co">#&gt;   id              PID   cell_id     x     y gender mhcII_status age_at_diagnosis</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> #01 0-889-121 … #01 …       5  453    2.5 F      low                        85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> #01 0-889-121 … #01 …       6  463    2.5 F      low                        85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> #01 0-889-121 … #01 …      11  464    8.5 F      low                        85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> #01 0-889-121 … #01 …      12  538   10   F      low                        85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> #01 0-889-121 … #01 …      21  522   20.5 F      low                        85</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> #01 0-889-121 … #01 …      22  566.  25   F      low                        85</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 31 more variables: stage_at_diagnosis &lt;chr&gt;, stage_numeric &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   pack_years &lt;dbl&gt;, survival_days &lt;dbl&gt;, survival_status &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   cause_of_death &lt;chr&gt;, adjuvant_therapy &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   time_to_recurrence_days &lt;dbl&gt;, recurrence_or_lung_ca_death &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   tissue_category &lt;chr&gt;, cd19 &lt;dbl&gt;, cd3 &lt;dbl&gt;, cd14 &lt;dbl&gt;, cd8 &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   hladr &lt;dbl&gt;, ck &lt;dbl&gt;, dapi &lt;dbl&gt;, entire_cell_axis_ratio &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   entire_cell_major_axis &lt;dbl&gt;, entire_cell_minor_axis &lt;dbl&gt;, …</span></span></span></code></pre></div>
<p>There are four immune cell types available in this dataset: CD14+
cell, CD4+ T cell, CD8+ T cell, and CD19+ B cell. We will examine the
pairwise colocalization of each cell type and its association with a
sample exhibiting an MHCII-high tumor microenvironment (TME). Here, we
generate each pair of cell types:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save the cell types</span></span>
<span><span class="va">cell.types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lung_df_tumor</span><span class="op">$</span><span class="va">type</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Generate all pairs of cells</span></span>
<span><span class="va">pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/combn.html" class="external-link">combn</a></span><span class="op">(</span><span class="va">cell.types</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>As described in the introductory vignette, <code>spagg</code>
contains six approaches for aggregating spatial summaries at a given
radius.</p>
<p>The first three approaches are weighted means of the summary
statistics:</p>
<ol style="list-style-type: decimal">
<li><p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>D</mi><mi>i</mi><mi>g</mi><mi>g</mi><mi>l</mi><mi>e</mi></mrow></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msub><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msub><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub><msub><mover><mi>K</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\begin{equation*}
\bar K_i^{Diggle} = \frac{1}{\sum_{r=1}^{R_i} n_{ir}} \sum_{r=1}^{R_i} n_{ir} \hat K_{ir}
\end{equation*}</annotation></semantics></math></p></li>
<li><p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>B</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>y</mi></mrow></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msubsup><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow><mn>2</mn></msubsup></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msubsup><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow><mn>2</mn></msubsup><msub><mover><mi>K</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\begin{equation*}
  \bar K_i^{Baddeley} = \frac{1}{\sum_{r=1}^{R_i} n^2_{ir}} \sum_{r=1}^{R_i} n^2_{ir} \hat K_{ir} \end{equation*}</annotation></semantics></math></p></li>
<li><p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>L</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>a</mi><mi>u</mi></mrow></msubsup><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msub><mi>A</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow><mrow><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msub><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><mfrac><msubsup><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow><mn>2</mn></msubsup><msub><mi>A</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub></mfrac><msub><mover><mi>K</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\begin{equation*}
  \bar K_i^{Landau} = \frac{\sum_{r=1}^{R_i} A_{ir}}{\sum_{r=1}^{R_i} n_{ir}} \sum_{r=1}^{R_i} \frac{n^2_{ir}}{A_{ir}} \hat K_{ir} 
\end{equation*}</annotation></semantics></math></p></li>
</ol>
<p>The last three are ensemble approaches which involve generating
random weights used to aggregate the spatial summaries:</p>
<ol start="4" style="list-style-type: decimal">
<li><p>Ensemble testing: in this approach, <code>spagg</code> randomly
generates weights from a standard normal distribution which are used to
construct a weighted mean of the Ripley’s K estimates obtained from each
ROI. This process is repeated many times. For each random set of
weights, the association between the weighted mean spatial summary and
sample-level outcomes is tested. The resulting p-values are combined
using the Cauchy combination test. This approach is contained in the
<code>ensemble.avg</code> function.</p></li>
<li><p>Resampling: in this approach, <code>spagg</code> randomly samples
one spatial summary statisti per sample and tests for an association
with the sample-level outcome. This process is repeated many times and
the resulting p-values are combined using the Cauchy combination test.
This approach is contained in the <code>resampling.avg</code>
function.</p></li>
<li><p>Combination testing: in this approach, <code>spagg</code>
randomly generates weights from a standard normal distribution and uses
these weights as well as the number of cells in each ROI to construct a
weighted mean of Ripley’s K estimates. This process is repeated many
times and the resulting p-values are combined using the Cauchy
combination test. This approach is contained in the
<code>combo.weight.avg</code> function.</p></li>
</ol>
<p>We will illustrate applying each of these six methods, as well as a
standard arithmetic mean, within the SPOT framework. The steps to our
analysis are as follows:</p>
<ol style="list-style-type: decimal">
<li><p>We will determine a range of candidate radii in advance. For this
analysis, we will use 10 radii between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>30</mn><annotation encoding="application/x-tex">30</annotation></semantics></math>.</p></li>
<li><p>We will compute Ripley’s K for each radius
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>0</mn><mo>,</mo><mn>10</mn><mo>,</mo><mn>20</mn><mo>,</mo><mn>30</mn></mrow><annotation encoding="application/x-tex">r = 0, 10, 20, 30</annotation></semantics></math>
and for each ROI. Within each sample, we will aggregate the spatial
summaries across ROIs using an arithmetic mean, the Diggle mean, the
Landau mean, and the Baddeley mean. We will then test for an association
between the aggregated spatial summaries and MHCII-high status. At the
end, we will aggregate the p-values using the Cauchy combination test
(CCT) <span class="citation">@liu2020cauchy</span>.</p></li>
<li><p>We will also use the ensemble approaches to aggregate the spatial
summaries and test for an association with the outcome. This will
involve two nested p-value combination steps: (1) at the ensemble
testing level, we will aggregate the p-values using the CCT across
ensemble replications; (2) at the SPOT level, we will aggregate the
ensemble p-values across radii using the CCT again.</p></li>
<li><p>At the end, we will assess which cell type pairs have significant
associations with MHCII-high status.</p></li>
</ol>
<p>Note that this analysis differs from the analysis presented in the
manuscript associated with this package. There, we considered a wider
range of radii and more ensemble replications. For the purposes of
illustration and simplicity, we reduce the number of radii and the
number of ensemble replications.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sarah Samorodnitsky.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
