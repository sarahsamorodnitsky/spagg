<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>spagg • spagg</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="spagg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spagg</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/spagg.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>spagg</h1>
            
      

      <div class="d-none name"><code>spagg.Rmd</code></div>
    </div>

    
    
<p>In this vignette, we will demonstrate how to use the
<code>spagg</code> package to aggregate replicated spatial summary
statistics estimated across multiple regions-of-interest (ROIs) imaged
from the same biospecimen, such as a tumor sample. We may possess data
for these specimens from multiplexed immunofluorescence imaging, which
yields spatial information on the cells residing in the tissue.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Loading in packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sarahsamorodnitsky.github.io/spagg/">spagg</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://spatstat.org/" class="external-link">spatstat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span></code></pre></div>
<p>Let’s consider using <code>spagg</code> to analyze a multiplexed
immunohistochemistry (mIHC) dataset generated from a non-small cell lung
cancer study by <span class="citation">Johnson et al. (2021)</span>.
Let’s examine the spatial distribution of CD4 T cells and examine its
association with major histocompatibility complex II (MHCII) status, a
tumor-level label. We will use Ripley’s K to characterize the spatial
distribution of CD4+ T cells.</p>
<p>Since this study cpatured multiple ROIs per tumor sample we need a
way of handling multiple estimates of Ripley’s K for each sample.
<code>spagg</code> provides several ways of doing so.</p>
<p>First, let’s load in the data we will use. This dataset will be
downloaded from <a href="http://juliawrobel.com/MI_tutorial/MI_Data.html" class="external-link uri">http://juliawrobel.com/MI_tutorial/MI_Data.html</a> but is
also available from the <code>VectraPolarisData</code> R package. For
the purposes of this illustration, we do some basic tidying of the data
prior to analysis. The steps to this tidying follow the steps shown in
the link given above. These steps are shown below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load in the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"http://juliawrobel.com/MI_tutorial/Data/lung.RDA"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Label the immune cell types</span></span>
<span><span class="va">lung_df</span> <span class="op">&lt;-</span> <span class="va">lung_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">phenotype_cd14</span> <span class="op">==</span> <span class="st">"CD14+"</span> <span class="op">~</span> <span class="st">"CD14+ cell"</span>,</span>
<span>    <span class="va">phenotype_cd19</span> <span class="op">==</span> <span class="st">"CD19+"</span> <span class="op">~</span> <span class="st">"CD19+ B cell"</span>,</span>
<span>    <span class="va">phenotype_cd4</span> <span class="op">==</span> <span class="st">"CD4+"</span> <span class="op">~</span> <span class="st">"CD4+ T cell"</span>,</span>
<span>    <span class="va">phenotype_cd8</span> <span class="op">==</span> <span class="st">"CD8+"</span> <span class="op">~</span> <span class="st">"CD8+ T cell"</span>,</span>
<span>    <span class="va">phenotype_other</span> <span class="op">==</span> <span class="st">"Other+"</span> <span class="op">~</span> <span class="st">"Other"</span>,</span>
<span>    <span class="va">phenotype_ck</span> <span class="op">==</span> <span class="st">"CK+"</span> <span class="op">~</span> <span class="st">"Tumor"</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a column indicating if a sample has &gt;=5% MHCII+ tumor cells</span></span>
<span><span class="va">lung_df</span> <span class="op">&lt;-</span> <span class="va">lung_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>                       </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">patient_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mhcII_high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mhcII_status</span> <span class="op">==</span> <span class="st">"high"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Change colnames</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span> <span class="op">==</span> <span class="st">"patient_id"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"PID"</span></span>
<span></span>
<span><span class="co"># Add a PID column</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lung_df</span><span class="op">)</span> <span class="op">==</span> <span class="st">"image_id"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"id"</span></span>
<span></span>
<span><span class="co"># Filter to just cells detected within the tumor</span></span>
<span><span class="va">lung_df_tumor</span> <span class="op">&lt;-</span> <span class="va">lung_df</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tissue_category</span> <span class="op">==</span> <span class="st">"Tumor"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove grouping</span></span>
<span><span class="va">lung_df_tumor</span> <span class="op">&lt;-</span> <span class="va">lung_df_tumor</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove NA types</span></span>
<span><span class="va">lung_df_tumor</span> <span class="op">&lt;-</span> <span class="va">lung_df_tumor</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">type</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will first consider different approaches to averaging Ripely’s K
across ROIs within a tumor sample. Let’s start by defining some
notation. Suppose for sample
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
we have
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>R</mi><mi>i</mi></msub><annotation encoding="application/x-tex">R_i</annotation></semantics></math>
ROIs. Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">n_{ir}</annotation></semantics></math>
be the number of cells in sample
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
ROI
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>.
Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>A</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">A_{ir}</annotation></semantics></math>
represent the area of sample
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
ROI
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>.
Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>K</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">\hat K_{ir}</annotation></semantics></math>
represent the spatial distribution of CD4+ T cells evaluate at radius
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>30</mn><annotation encoding="application/x-tex">30</annotation></semantics></math>.</p>
<p><code>spagg</code> contains implementations for the following three
weighted averages:</p>
<ol style="list-style-type: decimal">
<li><p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>D</mi><mi>i</mi><mi>g</mi><mi>g</mi><mi>l</mi><mi>e</mi></mrow></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msub><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msub><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub><msub><mover><mi>K</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\begin{equation*}
\bar K_i^{Diggle} = \frac{1}{\sum_{r=1}^{R_i} n_{ir}} \sum_{r=1}^{R_i} n_{ir} \hat K_{ir}
\end{equation*}</annotation></semantics></math></p></li>
<li><p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>B</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>y</mi></mrow></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msubsup><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow><mn>2</mn></msubsup></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msubsup><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow><mn>2</mn></msubsup><msub><mover><mi>K</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\begin{equation*}
  \bar K_i^{Baddeley} = \frac{1}{\sum_{r=1}^{R_i} n^2_{ir}} \sum_{r=1}^{R_i} n^2_{ir} \hat K_{ir} \end{equation*}</annotation></semantics></math></p></li>
<li><p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>L</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>a</mi><mi>u</mi></mrow></msubsup><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msub><mi>A</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow><mrow><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><msub><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>r</mi><mo>=</mo><mn>1</mn></mrow><msub><mi>R</mi><mi>i</mi></msub></munderover><mfrac><msubsup><mi>n</mi><mrow><mi>i</mi><mi>r</mi></mrow><mn>2</mn></msubsup><msub><mi>A</mi><mrow><mi>i</mi><mi>r</mi></mrow></msub></mfrac><msub><mover><mi>K</mi><mo accent="true">̂</mo></mover><mrow><mi>i</mi><mi>r</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\begin{equation*}
  \bar K_i^{Landau} = \frac{\sum_{r=1}^{R_i} A_{ir}}{\sum_{r=1}^{R_i} n_{ir}} \sum_{r=1}^{R_i} \frac{n^2_{ir}}{A_{ir}} \hat K_{ir} 
\end{equation*}</annotation></semantics></math></p></li>
</ol>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>D</mi><mi>i</mi><mi>g</mi><mi>g</mi><mi>l</mi><mi>e</mi></mrow></msubsup><annotation encoding="application/x-tex">\bar K_i^{Diggle}</annotation></semantics></math>
(<span class="citation">Diggle, Lange, and Beneš (1991)</span>),
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>B</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>e</mi><mi>l</mi><mi>e</mi><mi>y</mi></mrow></msubsup><annotation encoding="application/x-tex">\bar K_i^{Baddeley}</annotation></semantics></math>
(<span class="citation">Baddeley et al. (1993)</span>), and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mover><mi>K</mi><mo accent="true">‾</mo></mover><mi>i</mi><mrow><mi>L</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>a</mi><mi>u</mi></mrow></msubsup><annotation encoding="application/x-tex">\bar K_i^{Landau}</annotation></semantics></math>
(<span class="citation">Landau, Rabe-Hesketh, and Everall (2004)</span>)
were each proposed as approaches to aggregating replicated Ripley’s K
statistics.</p>
<p>Let’s estimate Ripley’s K for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>30</mn></mrow><annotation encoding="application/x-tex">r=30</annotation></semantics></math>
on each ROI. Note this may take several seconds (up to 30 seconds) to
run.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set the radius</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fl">30</span></span>
<span></span>
<span><span class="co"># Save the image IDs</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lung_df_tumor</span><span class="op">$</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initialize a data.frame to store the results for each ROI</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">lung_df_tumor</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">PID</span>, <span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>spatial <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                npoints <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                area <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span> </span>
<span><span class="co"># Iterate through the ROIs (this will take a few seconds)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span> <span class="co"># Save the ith image</span></span>
<span> <span class="va">image.i</span> <span class="op">&lt;-</span> <span class="va">lung_df_tumor</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="va">ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">type</span><span class="op">)</span></span>
<span></span>
<span>   <span class="co"># Convert to a point process object</span></span>
<span>   <span class="va">w</span> <span class="op">&lt;-</span> <span class="fu">spatstat.geom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/convexhull.xy.html" class="external-link">convexhull.xy</a></span><span class="op">(</span><span class="va">image.i</span><span class="op">$</span><span class="va">x</span>, <span class="va">image.i</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span>   <span class="va">image.i.subset</span> <span class="op">&lt;-</span> <span class="va">image.i</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"CD4+ T cell"</span><span class="op">)</span></span>
<span>   <span class="va">image.ppp</span> <span class="op">&lt;-</span> <span class="fu">spatstat.geom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/as.ppp.html" class="external-link">as.ppp</a></span><span class="op">(</span><span class="va">image.i.subset</span>, W <span class="op">=</span> <span class="va">w</span><span class="op">)</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/marks.html" class="external-link">marks</a></span><span class="op">(</span><span class="va">image.ppp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">image.i.subset</span><span class="op">$</span><span class="va">type</span></span>
<span></span>
<span>   <span class="co"># Compute Kest</span></span>
<span>   <span class="va">Ki</span> <span class="op">&lt;-</span> <span class="fu">spatstat.explore</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.explore/man/Kest.html" class="external-link">Kest</a></span><span class="op">(</span><span class="va">image.ppp</span>, r <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="va">r</span><span class="op">)</span></span>
<span>  </span>
<span>   <span class="co"># Calculate the number of points</span></span>
<span>   <span class="va">npoints.i</span> <span class="op">&lt;-</span> <span class="fu">spatstat.geom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/npoints.html" class="external-link">npoints</a></span><span class="op">(</span><span class="va">image.ppp</span><span class="op">)</span></span>
<span>   </span>
<span>   <span class="co"># Calculate the area</span></span>
<span>   <span class="va">area.i</span> <span class="op">&lt;-</span> <span class="fu">spatstat.geom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/area.owin.html" class="external-link">area</a></span><span class="op">(</span><span class="va">image.ppp</span><span class="op">)</span></span>
<span>  </span>
<span>   <span class="co"># Save the results</span></span>
<span>   <span class="va">results</span><span class="op">[</span><span class="va">results</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="va">ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="op">]</span><span class="op">$</span><span class="va">spatial</span> <span class="op">&lt;-</span> <span class="va">Ki</span><span class="op">$</span><span class="va">iso</span><span class="op">[</span><span class="va">r</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span>   <span class="va">results</span><span class="op">[</span><span class="va">results</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="va">ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="op">]</span><span class="op">$</span><span class="va">npoints</span> <span class="op">&lt;-</span> <span class="va">npoints.i</span></span>
<span>   <span class="va">results</span><span class="op">[</span><span class="va">results</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="va">ids</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="op">]</span><span class="op">$</span><span class="va">area</span> <span class="op">&lt;-</span> <span class="va">area.i</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># View the first few rows</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   PID           id                                  spatial npoints    area</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> #01 0-889-121 #01 0-889-121 P44_[40864,18015].im3      0        2 <span style="text-decoration: underline;">301</span>361.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> #01 0-889-121 #01 0-889-121 P44_[42689,19214].im3  <span style="text-decoration: underline;">47</span>576.       4 <span style="text-decoration: underline;">285</span>454.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> #01 0-889-121 #01 0-889-121 P44_[42806,16718].im3      0        3 <span style="text-decoration: underline;">332</span>974.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> #01 0-889-121 #01 0-889-121 P44_[44311,17766].im3      0        5 <span style="text-decoration: underline;">333</span>936.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> #01 0-889-121 #01 0-889-121 P44_[45366,16647].im3  <span style="text-decoration: underline;">27</span>781.       9 <span style="text-decoration: underline;">333</span>376.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> #02 1-037-393 #02 1-037-393 P44_[56576,16907].im3    <span style="color: #BB0000;">NaN</span>        0  <span style="text-decoration: underline;">52</span>210.</span></span></code></pre></div>
<p>Some of the Ripley’s K estimates will be <code>NaN</code>s as a
result of there being only
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0</mn><annotation encoding="application/x-tex">0</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>
CD4+ T cell in the corresponding image. We will remove these ROIs from
our analysis. We can now visualize the distribution of the spatial
summaries within each image as an illustration of the variation in
spatial distribution of CD4+ T cells across ROIs. The figure below
highlights the variation in Ripley’s K statistics within a single
sample.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove NAs</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">spatial</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># Visualize the distribution of spatial summaries within each sample</span></span>
<span><span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>PID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">PID</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PID</span>, y <span class="op">=</span> <span class="va">spatial</span>, group <span class="op">=</span> <span class="va">PID</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,  </span>
<span>         axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Ripley's K statistics for ROIs within a each sample"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Kest"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spagg_files/figure-html/remove%20NAs%20and%20plot-1.png" width="700"></p>
<p>After that, we will compute the weighted averages given above. We
will also compute a standard arithmetic mean as a comparison. Below, we
visualize the spread of the various spatial aggregation methods within
each sample. For some samples, the averages yield similar values. For
others, their values show large variation.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute averages</span></span>
<span><span class="va">results_mean</span> <span class="op">&lt;-</span> <span class="va">results</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">PID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_at</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">spatial</span><span class="op">)</span>,</span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, </span>
<span>                             <span class="op">~</span><span class="fu"><a href="../reference/landau.avg.html">landau.avg</a></span><span class="op">(</span>K.vec <span class="op">=</span> <span class="va">.x</span>, area.vec <span class="op">=</span> <span class="va">area</span>, n.vec <span class="op">=</span> <span class="va">npoints</span><span class="op">)</span>,</span>
<span>                             <span class="op">~</span><span class="fu"><a href="../reference/diggle.avg.html">diggle.avg</a></span><span class="op">(</span>K.vec <span class="op">=</span> <span class="va">.x</span>, n.vec <span class="op">=</span> <span class="va">npoints</span><span class="op">)</span>,</span>
<span>                             <span class="op">~</span><span class="fu"><a href="../reference/baddeley.avg.html">baddeley.avg</a></span><span class="op">(</span>K.vec <span class="op">=</span> <span class="va">.x</span>, n.vec <span class="op">=</span> <span class="va">npoints</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the averages</span></span>
<span><span class="va">results_mean</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, names_to <span class="op">=</span> <span class="st">"mean"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html" class="external-link">recode</a></span><span class="op">(</span><span class="va">mean</span>, </span>
<span>                              <span class="st">"mean"</span> <span class="op">=</span> <span class="st">"Arithmetic Mean"</span>,</span>
<span>                              <span class="st">"landau.avg"</span> <span class="op">=</span> <span class="st">"Landau Mean"</span>,</span>
<span>                              <span class="st">"diggle.avg"</span> <span class="op">=</span> <span class="st">"Diggle Mean"</span>,</span>
<span>                              <span class="st">"baddeley.avg"</span> <span class="op">=</span> <span class="st">"Baddeley Mean"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PID</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">mean</span>, color <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,  </span>
<span>        axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Average Kest"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Averaged Ripley's K within each sample"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_color_discrete</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Aggregation Method"</span><span class="op">)</span></span></code></pre></div>
<p><img src="spagg_files/figure-html/averages-1.png" width="700"></p>
<p>We now have a data.frame with a column corresponding to each average.
Let’s add in the MHCII-high status variable so we can do association
testing. We would like to test if the spatial arrangement of CD4+ T
cells is associated with MHCII-high status. We will compare the
significance of this association across the four spatial aggregation
methods.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First, check the ordering matches</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lung_df_tumor</span><span class="op">$</span><span class="va">PID</span><span class="op">)</span> <span class="op">==</span> <span class="va">results_mean</span><span class="op">$</span><span class="va">PID</span><span class="op">)</span> <span class="co"># TRUE!</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="co"># Add in MHCII-high status</span></span>
<span><span class="va">results_mean</span><span class="op">$</span><span class="va">mhcII_high</span> <span class="op">&lt;-</span> <span class="va">lung_df_tumor</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">PID</span>, <span class="va">mhcII_high</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">mhcII_high</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Test for an association between CD4 T cell spatial distributions and MHCII-high status</span></span>
<span><span class="va">mean.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">mhcII_high</span> <span class="op">~</span> <span class="va">mean</span>, data <span class="op">=</span> <span class="va">results_mean</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diggle.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">mhcII_high</span> <span class="op">~</span> <span class="va">diggle.avg</span>, data <span class="op">=</span> <span class="va">results_mean</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">baddeley.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">mhcII_high</span> <span class="op">~</span> <span class="va">baddeley.avg</span>, data <span class="op">=</span> <span class="va">results_mean</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">landau.glm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">mhcII_high</span> <span class="op">~</span> <span class="va">landau.avg</span>, data <span class="op">=</span> <span class="va">results_mean</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># P-values from each approach</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mean.glm</span><span class="op">)</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 0.2591465</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">diggle.glm</span><span class="op">)</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 0.3146754</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">baddeley.glm</span><span class="op">)</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 0.3192316</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">landau.glm</span><span class="op">)</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 0.3509682</span></span></code></pre></div>
<p>We did not find any significant associations between the spatial
distribution of CD4 T cells as estimated by Ripley’s K and MHCII-high
status at a radius of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>30</mn></mrow><annotation encoding="application/x-tex">r=30</annotation></semantics></math>.</p>
<p>We now illustrate using ensemble testing to test the same hypothesis.
<code>spagg</code> contains implementations for three different
approaches:</p>
<ul>
<li><p>Standard ensemble testing: in this approach, <code>spagg</code>
randomly generates weights from a standard normal distribution which are
used to construct a weighted mean of the Ripley’s K estimates obtained
from each ROI. This process is repeated many times. For each random set
of weights, the association between the weighted mean spatial summary
and sample-level outcomes is tested. The resulting p-values are combined
using the Cauchy combination test. This approach is contained in the
<code>ensemble.avg</code> function.</p></li>
<li><p>Resampling: in this approach, <code>spagg</code> randomly samples
one spatial summary statisti per sample and tests for an association
with the sample-level outcome. This process is repeated many times and
the resulting p-values are combined using the Cauchy combination test.
This approach is contained in the <code>resampling.avg</code>
function.</p></li>
<li><p>Combination testing: in this approach, <code>spagg</code>
randomly generates weights from a standard normal distribution and uses
these weights as well as the number of cells in each ROI to construct a
weighted mean of Ripley’s K estimates. This process is repeated many
times and the resulting p-values are combined using the Cauchy
combination test. This approach is contained in the
<code>combo.weight.avg</code> function.</p></li>
</ul>
<p>We now run each of these approaches to testing.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add the outcome back into the data</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">results</span>, </span>
<span>                     <span class="va">lung_df_tumor</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">PID</span>, <span class="va">mhcII_high</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>                     by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"PID"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run each ensemble test</span></span>
<span><span class="va">ensemble.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ensemble.avg.html">ensemble.avg</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">results</span>, group <span class="op">=</span> <span class="st">"PID"</span>, </span>
<span>                             outcome <span class="op">=</span> <span class="st">"mhcII_high"</span>, model <span class="op">=</span> <span class="st">"logistic"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resample.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/resampling.avg.html">resampling.avg</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">results</span>, group <span class="op">=</span> <span class="st">"PID"</span>, </span>
<span>                               outcome <span class="op">=</span> <span class="st">"mhcII_high"</span>, model <span class="op">=</span> <span class="st">"logistic"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combo.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combo.weight.avg.html">combo.weight.avg</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">results</span>, group <span class="op">=</span> <span class="st">"PID"</span>, </span>
<span>                              outcome <span class="op">=</span> <span class="st">"mhcII_high"</span>, model <span class="op">=</span> <span class="st">"logistic"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># P-values</span></span>
<span><span class="va">ensemble.res</span><span class="op">$</span><span class="va">pval</span></span>
<span><span class="co">#&gt; [1] 0.3749332</span></span>
<span><span class="va">resample.res</span><span class="op">$</span><span class="va">pval</span></span>
<span><span class="co">#&gt; [1] 0.5085036</span></span>
<span><span class="va">combo.res</span><span class="op">$</span><span class="va">pval</span></span>
<span><span class="co">#&gt; [1] 0.4716415</span></span></code></pre></div>
<p>The ensemble p-values also show no significance in the association
between the spatial clustering of CD4+ T cells and MHCII-high status
among tumor samples.</p>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-baddeley1993analysis" class="csl-entry">
Baddeley, AJ, RA Moyeed, CV Howard, and A Boyde. 1993. <span>“Analysis
of a Three-Dimensional Point Pattern with Replication.”</span>
<em>Journal of the Royal Statistical Society: Series C (Applied
Statistics)</em> 42 (4): 641–68.
</div>
<div id="ref-diggle1991analysis" class="csl-entry">
Diggle, Peter J, Nicholas Lange, and Francine M Beneš. 1991.
<span>“Analysis of Variance for Replicated Spatial Point Patterns in
Clinical Neuroanatomy.”</span> <em>Journal of the American Statistical
Association</em> 86 (415): 618–25.
</div>
<div id="ref-johnson2021cancer" class="csl-entry">
Johnson, Amber M, Jennifer M Boland, Julia Wrobel, Emily K Klezcko, Mary
Weiser-Evans, Katharina Hopp, Lynn Heasley, et al. 2021. <span>“Cancer
Cell-Specific Major Histocompatibility Complex II Expression as a
Determinant of the Immune Infiltrate Organization and Function in the
NSCLC Tumor Microenvironment.”</span> <em>Journal of Thoracic
Oncology</em> 16 (10): 1694–704.
</div>
<div id="ref-landau2004nonparametric" class="csl-entry">
Landau, Sabine, Sophia Rabe-Hesketh, and Ian P Everall. 2004.
<span>“Nonparametric One-Way Analysis of Variance of Replicated
Bivariate Spatial Point Patterns.”</span> <em>Biometrical Journal:
Journal of Mathematical Methods in Biosciences</em> 46 (1): 19–34.
</div>
</div>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sarah Samorodnitsky.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
